<script>
  /* ========= Config ========= */
  const repoOwner  = "redwywy2013";
  const repoName   = "Sound-Space-Maps";
  const branch     = "main";
  const mapsFolder = "maps";

  const container    = document.getElementById("maps");
  const searchInput  = document.getElementById("searchInput");
  const searchField  = document.getElementById("searchField");
  const statusEl     = document.getElementById("statusBar");

  /* ========= Cache (iOS Safari needs synchronous copy) ========= */
  const mapCache = new Map(); // key -> text
  // Broader Safari/iOS detection: includes iPadOS (which can report "Macintosh")
  const ua = navigator.userAgent;
  const isApple = /iPad|iPhone|iPod/.test(ua) || (navigator.platform === "MacIntel" && navigator.maxTouchPoints > 1);
  const isSafariEngine = /AppleWebKit/i.test(ua) && !/Chrome|Chromium|Edg/i.test(ua);
  const isSafari = isSafariEngine && (isApple || /Safari/i.test(ua));

  /* ========= Manual Copy Overlay (last-resort fallback) ========= */
  function ensureOverlay() {
    if (document.getElementById("copyOverlay")) return;
    const style = document.createElement("style");
    style.textContent = `
      .copy-overlay {
        position: fixed; inset: 0; background: rgba(0,0,0,.55);
        display: flex; align-items: center; justify-content: center; z-index: 1000;
      }
      .copy-modal {
        background: #12161d; border: 1px solid #1f2630; border-radius: 12px;
        max-width: 520px; width: calc(100% - 32px); padding: 16px;
        color: #e5e7eb; font-family: inherit;
      }
      .copy-modal h3 { margin: 0 0 8px; font-size: 16px; font-weight: 600; color: #38bdf8; }
      .copy-modal p { margin: 0 0 8px; font-size: 14px; color: #a7b0c0; }
      .copy-modal textarea {
        width: 100%; height: 160px; background: #0f172a; color: #e5e7eb;
        border: 1px solid #2a3342; border-radius: 8px; padding: 10px; font-size: 13px;
      }
      .copy-actions { display:flex; gap:8px; justify-content:flex-end; margin-top:10px; }
      .copy-btn {
        background:#1b2330; border:1px solid #2a3342; color:#e5e7eb;
        padding: 8px 12px; border-radius: 8px; cursor: pointer;
      }
      .copy-btn:hover { background:#223042; }
    `;
    document.head.appendChild(style);

    const overlay = document.createElement("div");
    overlay.className = "copy-overlay";
    overlay.id = "copyOverlay";
    overlay.innerHTML = `
      <div class="copy-modal" role="dialog" aria-modal="true" aria-labelledby="copyTitle">
        <h3 id="copyTitle">Manual Copy</h3>
        <p>If automatic copy didn’t work, long-press the text below and tap <b>Copy</b>.</p>
        <textarea id="copyText" readonly></textarea>
        <div class="copy-actions">
          <button class="copy-btn" id="overlayClose">Close</button>
        </div>
      </div>
    `;
    document.body.appendChild(overlay);

    document.getElementById("overlayClose").addEventListener("click", () => {
      overlay.remove();
    });
  }

  function openManualCopy(text) {
    ensureOverlay();
    const overlay = document.getElementById("copyOverlay");
    const ta = document.getElementById("copyText");
    ta.value = text || "";
    overlay.style.display = "flex";
    // Auto-select (helps some iOS versions)
    setTimeout(() => { ta.focus(); ta.select(); }, 50);
  }

  /* ========= Helpers ========= */
  function parseSSCM(text) {
    const data = {};
    text.split("\n").forEach(line => {
      if (line.startsWith("Map Data:")) {
        data.mapData = line.replace("Map Data:", "").trim();
      } else if (line.startsWith("Artist & Title:")) {
        data.song = line.replace("Artist & Title:", "").trim();
        const parts = data.song.split(" - ");
        data.artist = parts.length > 1 ? parts[0] : "";
        data.title  = parts.length > 1 ? parts.slice(1).join(" - ") : parts[0];
      } else if (line.startsWith("Mapper:")) {
        data.mapper = line.replace("Mapper:", "").trim();
      }
    });
    return data;
  }

  /* ========= Load maps (preload map data for instant copy) ========= */
  async function loadMaps() {
    try {
      const apiUrl = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${mapsFolder}?ref=${branch}`;
      const res = await fetch(apiUrl);
      if (!res.ok) throw new Error("Failed to load repository contents.");
      const files = await res.json();
      const sscmFiles = files.filter(f => f.name.endsWith(".sscm"));

      let loaded = 0;
      statusEl.textContent = `Loading: 0 / ${sscmFiles.length} Maps`;

      for (let i = 0; i < sscmFiles.length; i++) {
        const file = sscmFiles[i];
        const resFile = await fetch(file.download_url);
        const text = await resFile.text();
        const map = parseSSCM(text);

        const key = String(i);
        const btnId = `btn-${i}`;
        const needsFetch = /^https?:\/\//i.test(map.mapData);

        const card = document.createElement("div");
        card.className = "map-card";
        card.dataset.artist = (map.artist || "").toLowerCase();
        card.dataset.title  = (map.title  || "").toLowerCase();
        card.dataset.mapper = (map.mapper || "").toLowerCase();

        card.innerHTML = `
          <h2>${map.song || "Untitled"}</h2>
          <div class="meta"><span class="label">Mapper:</span><span class="value">${map.mapper || "Unknown"}</span></div>
          <button type="button" class="btn" id="${btnId}" data-key="${key}" ${needsFetch ? "disabled" : ""}>
            ${needsFetch ? "Preparing…" : "Copy Map Data"}
          </button>
        `;
        container.appendChild(card);

        // Prime cache now (no network in click):
        if (!needsFetch) {
          mapCache.set(key, map.mapData || "");
          const btn = document.getElementById(btnId);
          btn.textContent = "Copy Map Data";
          btn.disabled = false;
        } else {
          (async () => {
            try {
              const r = await fetch(map.mapData, { cache: "force-cache" });
              const t = await r.text();
              mapCache.set(key, t);
              const btn = document.getElementById(btnId);
              if (btn) { btn.textContent = "Copy Map Data"; btn.disabled = false; }
            } catch (e) {
              console.error("Failed to preload map data:", e);
              const btn = document.getElementById(btnId);
              if (btn) { btn.textContent = "Load failed"; btn.disabled = true; }
            }
          })();
        }

        document.getElementById(btnId).addEventListener("click", () => copyFromCache(key, btnId));

        loaded++;
        statusEl.textContent = `Loading: ${loaded} / ${sscmFiles.length} Maps`;
      }

      statusEl.textContent = `Done! Successfully loaded ${sscmFiles.length} maps.`;
      statusEl.classList.add("done");
    } catch (err) {
      console.error("Error loading maps:", err);
      statusEl.textContent = "Error loading maps.";
      statusEl.classList.add("error");
    }
  }

  /* ========= Copy (robust: modern API → execCommand → manual overlay) ========= */
  function copyFromCache(key, btnId) {
    const button = document.getElementById(btnId);
    const text = mapCache.get(key);

    if (!text) {
      button.textContent = "Still loading…";
      setTimeout(() => (button.textContent = "Copy Map Data"), 1200);
      return;
    }

    // 1) Try modern Clipboard API (works on newer iOS/Safari in a user gesture)
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(text).then(() => {
        successUI(button);
      }).catch(() => {
        // 2) Try execCommand fallback
        if (!execCommandCopy(text)) {
          // 3) Manual overlay
          openManualCopy(text);
          failUI(button, true); // don’t say failed; overlay is open
        } else {
          successUI(button);
        }
      });
      return;
    }

    // 2) Try execCommand fallback directly
    if (!execCommandCopy(text)) {
      // 3) Manual overlay
      openManualCopy(text);
      failUI(button, true);
    } else {
      successUI(button);
    }
  }

  function execCommandCopy(text) {
    try {
      const textarea = document.createElement("textarea");
      textarea.value = text;
      textarea.setAttribute("readonly", "");
      textarea.style.position = "fixed";
      textarea.style.opacity = "0";
      textarea.style.left = "-9999px";
      document.body.appendChild(textarea);
      textarea.focus();
      textarea.select();
      textarea.setSelectionRange(0, textarea.value.length); // iOS-friendly
      const ok = document.execCommand("copy"); // boolean result
      document.body.removeChild(textarea);
      return ok;
    } catch {
      return false;
    }
  }

  function successUI(button) {
    button.textContent = "Copied ✓";
    button.classList.add("copied");
    setTimeout(() => {
      button.textContent = "Copy Map Data";
      button.classList.remove("copied");
    }, 1600);
  }

  function failUI(button, silent = false) {
    if (silent) return; // overlay opened
    button.textContent = "Copy failed";
    setTimeout(() => (button.textContent = "Copy Map Data"), 1600);
  }

  /* ========= Search ========= */
  searchInput.addEventListener("input", filterMaps);
  searchField.addEventListener("change", filterMaps);

  function filterMaps() {
    const query = (searchInput.value || "").toLowerCase().trim();
    const field = searchField.value;
    const cards = document.querySelectorAll(".map-card");
    cards.forEach(card => {
      if (!query) { card.style.display = ""; return; }
      let show = false;
      if (field === "all") {
        show =
          card.dataset.artist.includes(query) ||
          card.dataset.title.includes(query) ||
          card.dataset.mapper.includes(query);
      } else {
        show = (card.dataset[field] || "").includes(query);
      }
      card.style.display = show ? "" : "none";
    });
  }

  /* ========= Changelog ========= */
  const changelogTab = document.getElementById("changelogTab");
  const changelogPanel = document.getElementById("changelogPanel");
  const changelogContent = document.getElementById("changelogContent");

  changelogTab.addEventListener("click", () => {
    changelogPanel.classList.toggle("open");
  });

  async function loadChangelog() {
    try {
      const url = `https://raw.githubusercontent.com/${repoOwner}/${repoName}/${branch}/changelog.txt`;
      const res = await fetch(url);
      if (!res.ok) throw new Error("Changelog not found");
      const text = await res.text();
      changelogContent.textContent = text;
    } catch {
      changelogContent.textContent = "No changelog available.";
    }
  }

  /* ========= Init ========= */
  loadMaps();
  loadChangelog();
</script>
